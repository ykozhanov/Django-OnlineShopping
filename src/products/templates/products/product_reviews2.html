<div class="Tabs-block" id="reviews">
    <header class="Section-header">
        <h3 class="Section-title" id="review-count">
            <span id="review-count-number"></span>
            <span id="review-count-text"></span>
        </h3>
    </header>
    <div id="reviews-container"></div>
    <div id="load-more-container" style="display: flex; justify-content: center; margin-top: 20px;">
        <button id="load-more-button" class="btn btn_muted" style="display: none;">Показать еще</button>
    </div>

    {% if user.is_authenticated %}
    <header class="Section-header Section-header_product">
        <h3 class="Section-title">Добавить отзыв</h3>
    </header>
    <div class="Tabs-addComment">
        <div id="error-messages" style="color: red;"></div>
        <form id="review-form" class="form" method="post">
            {% csrf_token %}
            <div class="form-group">
                <textarea class="form-textarea" name="text" id="review" placeholder="Отзыв"></textarea>
            </div>
            <div class="form-group">
                <button class="btn btn_muted" type="submit">Отправить отзыв</button>
            </div>
        </form>
    </div>
    {% else %}
    <header class="Section-header Section-header_product">
        <h3 class="Section-title">
            <div>Чтобы оставить отзыв, вам нужно авторизоваться</div>
            <div><a href="#">Вход</a></div>
        </h3>
    </header>
    {% endif %}

</div>

<script>
    document.getElementById('load-reviews-link').addEventListener('click', function(event) {
        event.preventDefault();
        const objectId = {{ object.pk }};
        const csrfToken = '{{ csrf_token }}';

        fetch(`{% url 'load_reviews' pk=object.pk offset=0 %}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {

            // Скрипт для отображения отзывов
            const reviewsContainer = document.getElementById('reviews-container');
            reviewsContainer.innerHTML = '';
            data.reviews.forEach(review => {
                const reviewHtml = `
                    <div class="Comments">
                        <div class="Comment">
                            <div class="Comment-column Comment-column_pict">
                                <div class="Comment-avatar"></div>
                            </div>
                            <div class="Comment-column">
                                <header class="Comment-header">
                                    <div>
                                        <strong class="Comment-title">${review.username}</strong>
                                        <span class="Comment-date">${review.created_at}</span>
                                    </div>
                                </header>
                                <div class="Comment-content">${review.text}</div>
                            </div>
                        </div>
                    </div>
                `;
                reviewsContainer.insertAdjacentHTML('beforeend', reviewHtml);
            });

            const reviewCountElement = document.getElementById('review-count-number');
            const reviewCountTextElement = document.getElementById('review-count-text');
            const reviewCount = data.review_count;
            reviewCountElement.innerHTML = reviewCount;

            let pluralizedText;
            if (reviewCount === 1) {
                pluralizedText = 'отзыв';
            } else if (reviewCount >= 2 && reviewCount <= 4) {
                pluralizedText = 'отзыва';
            } else {
                pluralizedText = 'отзывов';
            }
            reviewCountTextElement.innerHTML = pluralizedText;

            const loadMoreButton = document.getElementById('load-more-button');
            if (data.reviews.length >= 5) {
                loadMoreButton.style.display = 'block';
            } else {
                loadMoreButton.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });
    });

    // Скрипт для добавления нового отзыва без обновления страницы
    document.getElementById('review-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
        const text = form.querySelector('[name=text]').value;
        const objectId = {{ object.pk }};

        fetch(`{% url 'add_review' pk=object.pk %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'text': text,
                'csrfmiddlewaretoken': csrfToken
            })
        })
        .then(response => {
            if (response.status === 400) {
                return response.json().then(data => {
                    throw data;
                });
            }
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            const reviewsContainer = document.getElementById('reviews-container');
            const reviewHtml = `
                <div class="Comments">
                    <div class="Comment">
                        <div class="Comment-column Comment-column_pict">
                            <div class="Comment-avatar"></div>
                        </div>
                        <div class="Comment-column">
                            <header class="Comment-header">
                                <div>
                                    <strong class="Comment-title">${data.username}</strong>
                                    <span class="Comment-date">${data.created_at}</span>
                                </div>
                            </header>
                            <div class="Comment-content">${data.text}</div>
                        </div>
                    </div>
                </div>
            `;

            reviewsContainer.insertAdjacentHTML('afterbegin', reviewHtml);

            const reviewCountElement = document.getElementById('review-count-number');
            const reviewCountTextElement = document.getElementById('review-count-text');
            reviewCountElement.innerHTML = data.review_count;

            let pluralizedText;
            if (data.review_count === 1) {
                pluralizedText = 'отзыв';
            } else if (data.review_count >= 2 && data.review_count <= 4) {
                pluralizedText = 'отзыва';
            } else {
                pluralizedText = 'отзывов';
            }
            reviewCountTextElement.innerHTML = pluralizedText;

            form.reset();
            document.getElementById('error-messages').innerHTML = '';
        })
        // Обработка ошибки валидации
        .catch(error => {
            if (error.errors) {
                const errorMessages = document.getElementById('error-messages');
                errorMessages.innerHTML = '';
                for (const field in error.errors) {
                    const errorList = document.createElement('ul');
                    error.errors[field].forEach(errorMsg => {
                        const errorItem = document.createElement('li');
                        errorItem.textContent = errorMsg;
                        errorList.appendChild(errorItem);
                    });
                    errorMessages.appendChild(errorList);
                }
            } else {
                console.error('There was a problem with the fetch operation:', error);
            }
        });
    });

    // Скрипт для добавления кнопки "показать еще"
    document.getElementById('load-more-button').addEventListener('click', function() {
        const objectId = {{ object.pk }};
        const offset = document.querySelectorAll('.Comments').length;
        const csrfToken = '{{ csrf_token }}';

        fetch(`{% url 'load_reviews' pk=object.pk offset=0 %}`.replace('0', offset), {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            const reviewsContainer = document.getElementById('reviews-container');
            data.reviews.forEach(review => {
                const reviewHtml = `
                    <div class="Comments">
                        <div class="Comment">
                            <div class="Comment-column Comment-column_pict">
                                <div class="Comment-avatar"></div>
                            </div>
                            <div class="Comment-column">
                                <header class="Comment-header">
                                    <div>
                                        <strong class="Comment-title">${review.username}</strong>
                                        <span class="Comment-date">${review.created_at}</span>
                                    </div>
                                </header>
                                <div class="Comment-content">${review.text}</div>
                            </div>
                        </div>
                    </div>
                `;
                reviewsContainer.insertAdjacentHTML('beforeend', reviewHtml);
            });

            const loadMoreButton = document.getElementById('load-more-button');
            if (!data.has_more) {
                loadMoreButton.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });
    });
</script>

